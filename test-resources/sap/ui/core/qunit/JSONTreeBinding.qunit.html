<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />

<!-- Initialization -->
<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-language="en_US">
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>

<!-- Test functions -->
<script language="javascript" charset="utf-8"> // IE needs this :-/

	var oModel;
	var testData;
	var bindings;

	function setup(){
		// reset bindings
		bindings = new Array();
		testData = {
			orgStructure:{
				 0: {
					name: "Peter Cliff",
					gender: "male",
					0: {
						name: "Inga Horst",
						gender: "female",
						0: {
							name: "John Wallace",
							gender: "male"
						},
						1: {
							name: "Frank Wallace",
							gender: "male"
						},
						2: {
							name: "Gina Rush",
							gender: "female"
						},
						noTreeNode: null //Test cases should not break because of null nodes
					},
					1: {
						name: "Tom Bay",
						gender: "male"
					},
					2: {
						name: "Catherine Platte",
						gender: "female"
					},
					noTreeNode: null
				}
			},
			orgStructure2: [
				{
					name: "Inga Horst",
					gender: "female",
					children: [
						{
							name: "John Wallace",
							gender: "male"
						},
						{
							name: "Frank Wallace",
							gender: "male"
						},
						{
							name: "Gina Rush",
							gender: "female"
						},
						null
					]
				},
				{
					name: "Tom Bay",
					gender: "male"
				},
				{
					name: "Catherine Platte",
					gender: "female"
				},
				null
			]
		};
		oModel = new sap.ui.model.json.JSONModel();
		oModel.setData(testData);
		sap.ui.getCore().setModel(oModel);

	};


	//creates a certain data
	function createData(iAmount) {
		var oData = {
			root:{
				id: "root",
				name: "root",
				description: "moep moep",
				checked: false,
				children: []
			}
		};

		var addChildren = function (oNode, iChildCount) {
			for (var i = 0; i < iChildCount; i++) {
				var sGroupID = oNode.id + "-" + i;
				oNode.children.push({
					id: sGroupID,
					name: "Node(" + sGroupID +")",
					description: "Hello, I am the description for node #" + sGroupID,
					children: []
				});
			}
		};

		addChildren(oData.root, iAmount);

		for (var i = 0; i < oData.root.children.length; i++) {
			var oChild = oData.root.children[i];
			addChildren(oChild, iAmount);
		}

		oModel = new sap.ui.model.json.JSONModel();
		oModel.setData(oData);
		sap.ui.getCore().setModel(oModel);
	};


	function createTreeBinding(sPath, oContext, mParameters){
		// create binding
		bindings = new Array();
		bindings[0] = oModel.bindTree(sPath, oContext, [], mParameters);
	};

	test("TreeBinding getRootContexts getNodeContexts", function(){
		setup();
		createTreeBinding("/orgStructure");
		var treeBinding = bindings[0],
			contexts,
			context;

		equal(treeBinding.getPath(), "/orgStructure", "TreeBinding path");
		equal(treeBinding.getModel(), oModel, "TreeBinding model");

		contexts = treeBinding.getRootContexts();
		equal(contexts.length, 1, "TreeBinding rootContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "Peter Cliff", "TreeBinding root content");

		contexts = treeBinding.getNodeContexts(context);
		equal(contexts.length, 3, "TreeBinding nodeContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "Inga Horst", "TreeBinding node content");

		context = contexts[2];
		equal(oModel.getProperty("name", context), "Catherine Platte", "TreeBinding node content");

		equal(treeBinding.getChildCount(contexts[0]), 3, "TreeBinding childcount");
		contexts = treeBinding.getNodeContexts(contexts[0]);
		equal(contexts.length, 3, "TreeBinding nodeContexts length");

		context = contexts[1];
		equal(oModel.getProperty("name", context), "Frank Wallace", "TreeBinding node content");

	});

	test("TreeBinding getRootContexts getNodeContexts", function(){
		setup();
		createTreeBinding("/orgStructure");
		var treeBinding = bindings[0],
			contexts,
			context;

		ok(treeBinding instanceof sap.ui.model.json.JSONTreeBinding, "treeBinding class check");
		contexts = treeBinding.getRootContexts();
		equal(contexts.length, 1, "TreeBinding rootContexts length");

		var newData = {
			orgStructure:{
				0: {
					name: "root1",
					0: {
						name: "subnode1",
						0: {
							name: "subsubnode1"
						}
					}
				},
				1: {
					name: "root2",
					0: {
						name: "subnode2"
					}
				}
			}
		};
		oModel.setData(newData);
		createTreeBinding("/orgStructure");
		treeBinding = bindings[0];

		contexts = treeBinding.getRootContexts();
		equal(contexts.length, 2, "TreeBinding rootContexts length");
		context = contexts[1];
		contexts = treeBinding.getNodeContexts(context);
		equal(contexts.length, 1, "TreeBinding nodeContexts length");
		context = contexts[0];
		equal(oModel.getProperty("name", context), "subnode2", "TreeBinding node content");
	});

	test("TreeBinding single filters", function(){
		setup();
		createTreeBinding("/orgStructure");

		var treeBinding = bindings[0];

		// Filter for node with name containing 'in', only one expected: Gina Rush
		var oFilter1 = new sap.ui.model.Filter("name", sap.ui.model.FilterOperator.Contains, "in");
		treeBinding.filter(oFilter1);

		var filteredContext = treeBinding.getRootContexts();
		equal(filteredContext.length, 1, "TreeBinding rootContexts length");

		var nodeContexts1 = treeBinding.getNodeContexts(filteredContext[0]);
		equal(nodeContexts1.length, 2, "TreeBinding nodeContexts length");

		var nodeContexts2 = treeBinding.getNodeContexts(nodeContexts1[0]);
		equal(nodeContexts2.length, 1, "TreeBinding nodeContexts length");

		equal(oModel.getProperty(nodeContexts2[0].getPath()).name, "Gina Rush", "TreeBinding filter value");
		equal(oModel.getProperty(nodeContexts1[1].getPath()).name, "Catherine Platte", "TreeBinding filter value");
	});

	test("TreeBinding multi filters", function(){
		setup();
		createTreeBinding("/orgStructure");

		var treeBinding = bindings[0];

		var oFilter1 = new sap.ui.model.Filter("name", sap.ui.model.FilterOperator.Contains, "in");
		var oFilter2 = new sap.ui.model.Filter("name", sap.ui.model.FilterOperator.Contains, "al");
		var oMultiFilter1 = new sap.ui.model.Filter([oFilter1, oFilter2], false);
		var oFilter3 = new sap.ui.model.Filter("gender", sap.ui.model.FilterOperator.EQ, "female");
		var oMultiFilter2 = new sap.ui.model.Filter([oMultiFilter1, oFilter3], true);
		treeBinding.filter([oMultiFilter2]);
		var filteredContext = treeBinding.getRootContexts();
		equal(filteredContext.length, 1, "TreeBinding rootContexts length");
		var nodeContexts1 = treeBinding.getNodeContexts(filteredContext[0]);
		equal(nodeContexts1.length, 2, "TreeBinding nodeContexts length");
		var nodeContexts2 = treeBinding.getNodeContexts(nodeContexts1[0]);
		equal(nodeContexts2.length, 1, "TreeBinding nodeContexts length");
		equal(oModel.getProperty(nodeContexts2[0].getPath()).name, "Gina Rush", "TreeBinding filter value");
		equal(oModel.getProperty(nodeContexts1[1].getPath()).name, "Catherine Platte", "TreeBinding filter value");
	});

	test("Display root node", function() {
		setup();
		createTreeBinding("/orgStructure/0", null, {
			displayRootNode: true
		});

		var treeBinding = bindings[0],
			contexts,
			context;

		equal(treeBinding.getPath(), "/orgStructure/0", "TreeBinding path");
		equal(treeBinding.getModel(), oModel, "TreeBinding model");

		contexts = treeBinding.getRootContexts();
		equal(contexts.length, 1, "TreeBinding rootContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "Peter Cliff", "TreeBinding root content");

		contexts = treeBinding.getNodeContexts(context);
		equal(contexts.length, 3, "TreeBinding nodeContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "Inga Horst", "TreeBinding node content");

		context = contexts[2];
		equal(oModel.getProperty("name", context), "Catherine Platte", "TreeBinding node content");

		contexts = treeBinding.getNodeContexts(contexts[0]);
		equal(contexts.length, 3, "TreeBinding nodeContexts length");

		context = contexts[1];
		equal(oModel.getProperty("name", context), "Frank Wallace", "TreeBinding node content");
	});

	test("Bind aggregation", function() {
		setup();
		createTreeBinding("/orgStructure2", null, {
			displayRootNode: true
		});

		var treeBinding = bindings[0],
			contexts,
			context;

		equal(treeBinding.getPath(), "/orgStructure2", "TreeBinding path");
		equal(treeBinding.getModel(), oModel, "TreeBinding model");

		contexts = treeBinding.getRootContexts();
		equal(contexts.length, 3, "TreeBinding rootContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "Inga Horst", "TreeBinding root content");

		context = contexts[1];
		equal(oModel.getProperty("name", context), "Tom Bay", "TreeBinding root content");

		context = contexts[2];
		equal(oModel.getProperty("name", context), "Catherine Platte", "TreeBinding root content");

		contexts = treeBinding.getNodeContexts(contexts[0]);
		equal(contexts.length, 3, "TreeBinding nodeContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "John Wallace", "TreeBinding node content");

		context = contexts[1];
		equal(oModel.getProperty("name", context), "Frank Wallace", "TreeBinding node content");

		context = contexts[2];
		equal(oModel.getProperty("name", context), "Gina Rush", "TreeBinding node content");
	});

	test("Paging", function() {
		setup();
		createTreeBinding("/orgStructure2", {
			displayRootNode: true
		});

		var treeBinding = bindings[0],
			contexts,
			context;

		equal(treeBinding.getPath(), "/orgStructure2", "TreeBinding path");
		equal(treeBinding.getModel(), oModel, "TreeBinding model");

		contexts = treeBinding.getRootContexts(0,2);
		equal(contexts.length, 2, "TreeBinding returned rootContexts length");
		equal(treeBinding.getChildCount(null), 3, "TreeBinding actual rootContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "Inga Horst", "TreeBinding root content");

		context = contexts[1];
		equal(oModel.getProperty("name", context), "Tom Bay", "TreeBinding root content");

		context = contexts[0];
		contexts = treeBinding.getNodeContexts(context, 1, 2);
		equal(contexts.length, 2, "TreeBinding returned nodeContexts length");
		equal(treeBinding.getChildCount(context), 3, "TreeBinding actual nodeContexts length");

		context = contexts[0];
		equal(oModel.getProperty("name", context), "Frank Wallace", "TreeBinding node content");

		context = contexts[1];
		equal(oModel.getProperty("name", context), "Gina Rush", "TreeBinding node content");
	});

	test("Sorting", function () {
		setup();
		createTreeBinding("/orgStructure2", {
			displayRootNode: true
		});

		var treeBinding = bindings[0];

		treeBinding.sort(new sap.ui.model.Sorter("name"));

		var aRootContexts = treeBinding.getRootContexts(0, 3);

		equal(aRootContexts[0].getProperty("name"), "Catherine Platte", "1st node after sorting is: Catherine Platte");
		equal(aRootContexts[1].getProperty("name"), "Inga Horst", "2nd node after sorting is: Inga Horst");
		equal(aRootContexts[2].getProperty("name"), "Tom Bay", "3rd node after sorting is: Tom Bay");

		var aChildContexts = treeBinding.getNodeContexts(aRootContexts[1]);
		equal(aChildContexts[0].getProperty("name"), "Frank Wallace", "Inga child node[0] after sorting is: Frank Wallace");
		equal(aChildContexts[1].getProperty("name"), "Gina Rush", "Inga child node[1] after sorting is: Gina Rush");
		equal(aChildContexts[2].getProperty("name"), "John Wallace", "Inga child node[2]] after sorting is: John Wallace");

	});

	test("Check public API calls for tree with >1000 nodes", function () {
		//create a tree with 2 levels and 200 * 200 nodes
		createData(200);
		createTreeBinding("/root", null, [], {
			displayRootNode: false
		});

		var oBinding = bindings[0];

		ok(!oBinding.hasChildren(), "hasChildren() with no arguments still returns 'false'");

		var aRootContexts = oBinding.getRootContexts(0, 200);

		equal(aRootContexts.length, 200, "Number of Root Contexts is correct");
		equal(oBinding.getChildCount(), 200, "getChildCount() returns the correct value (200)");
		equal(oBinding.getChildCount(null), 200, "getChildCount(null) returns the correct value (200)");

		//check if child contexts are returned correctly
		var oContext = aRootContexts[42];
		//paged access with some additional nodes at the end (should not be there)
		var aChildContexts = oBinding.getNodeContexts(oContext, 30, 400);

		equal(aChildContexts.length, 170, "Number of child contexts is correct (170)");
		equal(oBinding.getChildCount(oContext), 200, "getChildCount(oContext) returns the correct number of child nodes (200)");

		//one level deeper should be empty
		var oContext = aChildContexts[128];
		ok(oContext, "level 1 child is available");
		equal(oBinding.getChildCount(oContext), 0, "getChildCount(oContext) returns the correct number of child nodes (0)");
	});

	</script>

</head>
<body>
<h1 id="qunit-header">QUnit tests: JSON Tree Binding</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<div id="qunit-testrunner-toolbar"></div>
<ol id="qunit-tests"></ol>
</body>
</html>
